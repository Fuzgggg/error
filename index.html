<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiplayer 3D Game</title>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#000; }
    #chatBox {
      position:absolute; right:10px; bottom:10px; width:250px; height:300px;
      background:rgba(0,0,0,0.6); color:#fff; font-family:sans-serif;
      display:flex; flex-direction:column; border-radius:8px; overflow:hidden;
    }
    #messages { flex:1; overflow-y:auto; padding:5px; font-size:14px; }
    #inputBox { display:flex; }
    #msgInput { flex:1; border:none; padding:5px; }
    #sendBtn { width:60px; border:none; background:#2ecc71; color:#fff; }
    #roomBox {
      position:absolute; top:10px; left:10px; padding:10px;
      background:rgba(0,0,0,0.6); color:#fff; border-radius:8px;
    }
    #joystick {
      position:absolute; left:20px; bottom:20px;
      width:120px; height:120px; border-radius:50%;
      background:rgba(255,255,255,0.2); touch-action:none;
    }
    #stick {
      position:absolute; left:40px; top:40px;
      width:40px; height:40px; border-radius:50%;
      background:#2ecc71;
    }
  </style>
</head>
<body>
  <div id="roomBox">
    Room: <input id="roomInput" placeholder="Room code" />
    <button onclick="joinRoom()">Join</button>
  </div>
  <div id="chatBox">
    <div id="messages"></div>
    <div id="inputBox">
      <input id="msgInput" placeholder="Type message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
  <div id="joystick"><div id="stick"></div></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    // === FIREBASE SETUP ===
    const firebaseConfig = {
      apiKey: "AIzaSyCGI0vM6vlw1xF80R6pdXFSqfR5fd9GmA",
      authDomain: "my-project-80758-1738239739321.firebaseapp.com",
      databaseURL: "https://my-project-80758-1738239739321-default-rtdb.firebaseio.com/",
      projectId: "my-project-80758-1738239739321",
      storageBucket: "my-project-80758-1738239739321.appspot.com",
      messagingSenderId: "466967000524",
      appId: "1:466967000524:web:42a703c14c78c586275969",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomCode = null;
    let playerId = "p" + Math.floor(Math.random()*9999);
    let players = {};
    let playerObj = null;

    // === THREE.JS SCENE ===
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,5,10);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);

    // Light
    const hemiLight = new THREE.HemisphereLight(0xffffff,0x444444,1.2);
    hemiLight.position.set(0,200,0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff,1);
    dirLight.position.set(-10,10,5);
    scene.add(dirLight);

    // Ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(100,100),
      new THREE.MeshPhongMaterial({color:0x228B22})
    );
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // === PLAYER & ANIMATION ===
    let mixer = null;
    let actions = {};
    let activeAction = null;

    const loader = new THREE.GLTFLoader();
    loader.load("https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb", gltf=>{
      playerObj = gltf.scene;
      playerObj.scale.set(0.4,0.4,0.4);
      playerObj.position.set(0,0,0);
      scene.add(playerObj);

      mixer = new THREE.AnimationMixer(playerObj);
      gltf.animations.forEach(clip => {
        actions[clip.name] = mixer.clipAction(clip);
      });

      activeAction = actions["Idle"];
      activeAction.play();
    });

    // Other players
    function spawnOtherPlayer(id){
      const geom = new THREE.SphereGeometry(0.5,16,16);
      const mat = new THREE.MeshBasicMaterial({color:Math.random()*0xffffff});
      const mesh = new THREE.Mesh(geom,mat);
      scene.add(mesh);
      players[id] = mesh;
    }

    // Movement
    let keys = {};
    document.addEventListener("keydown", e=>{
      keys[e.key]=true;

      // Trigger animasi tambahan
      if(playerObj && mixer){
        if(e.key === " " && actions["Jump"]){
          if(activeAction) activeAction.fadeOut(0.2);
          activeAction = actions["Jump"];
          activeAction.reset().fadeIn(0.1).play();
          activeAction.clampWhenFinished = true;
          activeAction.loop = THREE.LoopOnce;
          activeAction.onFinished = ()=>{ activeAction = actions["Idle"]; activeAction.play(); };
        }
        if(e.key.toLowerCase() === "c" && actions["Sit"]){
          if(activeAction) activeAction.fadeOut(0.2);
          activeAction = actions["Sit"];
          activeAction.reset().fadeIn(0.2).play();
        }
        if(e.key.toLowerCase() === "v" && actions["Wave"]){
          if(activeAction) activeAction.fadeOut(0.2);
          activeAction = actions["Wave"];
          activeAction.reset().fadeIn(0.2).play();
          activeAction.clampWhenFinished = true;
          activeAction.loop = THREE.LoopOnce;
          activeAction.onFinished = ()=>{ activeAction = actions["Idle"]; activeAction.play(); };
        }
      }
    });
    document.addEventListener("keyup", e=>keys[e.key]=false);

    let joystick = document.getElementById("joystick");
    let stick = document.getElementById("stick");
    let joy = {dx:0,dy:0};

    joystick.addEventListener("touchstart", e=>{ e.preventDefault(); });
    joystick.addEventListener("touchmove", e=>{
      let rect = joystick.getBoundingClientRect();
      let x = e.touches[0].clientX - rect.left - 60;
      let y = e.touches[0].clientY - rect.top - 60;
      let dist = Math.sqrt(x*x+y*y);
      if(dist>40){ x*=40/dist; y*=40/dist; }
      stick.style.left = (60+x-20)+"px";
      stick.style.top = (60+y-20)+"px";
      joy.dx = x/40; joy.dy = y/40;
    });
    joystick.addEventListener("touchend", ()=>{
      stick.style.left="40px"; stick.style.top="40px";
      joy.dx=0; joy.dy=0;
    });

    function movePlayer(){
      if(!playerObj) return;
      let speed = 0.1;
      let moving = false;
      let running = false;

      // Hitung vektor gerak
      let dx = 0, dz = 0;
      if(keys["Shift"]) speed = 0.2;
      if(keys["w"] || joy.dy<-0.3){ dz -= speed; moving = true; if(speed>0.1) running=true; }
      if(keys["s"] || joy.dy>0.3){ dz += speed; moving = true; if(speed>0.1) running=true; }
      if(keys["a"] || joy.dx<-0.3){ dx -= speed; moving = true; if(speed>0.1) running=true; }
      if(keys["d"] || joy.dx>0.3){ dx += speed; moving = true; if(speed>0.1) running=true; }

      // Update posisi
      playerObj.position.x += dx;
      playerObj.position.z += dz;

      // Rotasi karakter sesuai arah gerak
      if(moving){
        let angle = Math.atan2(dx, dz);
        playerObj.rotation.y = angle;
      }

      // Update animasi utama
      if(mixer){
        if(moving && running && activeAction !== actions["Run"]){
          if(activeAction) activeAction.fadeOut(0.2);
          activeAction = actions["Run"];
          activeAction.reset().fadeIn(0.2).play();
        } else if(moving && !running && activeAction !== actions["Walk"]){
          if(activeAction) activeAction.fadeOut(0.2);
          activeAction = actions["Walk"];
          activeAction.reset().fadeIn(0.2).play();
        } else if(!moving && activeAction !== actions["Idle"]){
          if(activeAction) activeAction.fadeOut(0.2);
          activeAction = actions["Idle"];
          activeAction.reset().fadeIn(0.2).play();
        }
        mixer.update(0.016);
      }

      // Update posisi di Firebase
      if(roomCode){
        db.ref("rooms/"+roomCode+"/players/"+playerId).set({
          x: playerObj.position.x,
          y: playerObj.position.y,
          z: playerObj.position.z
        });
      }
    }

    // Join room
    function joinRoom(){
      roomCode = document.getElementById("roomInput").value;
      if(roomCode){
        db.ref("rooms/"+roomCode+"/players/"+playerId).set({x:0,y:0,z:0});
        db.ref("rooms/"+roomCode+"/players").on("value", snap=>{
          const data = snap.val()||{};
          for(let id in data){
            if(id!==playerId){
              if(!players[id]) spawnOtherPlayer(id);
              let p = players[id];
              p.position.set(data[id].x, data[id].y, data[id].z);
            }
          }
        });
        db.ref("rooms/"+roomCode+"/chat").on("child_added", snap=>{
          const msg = snap.val();
          let div = document.createElement("div");
          div.textContent = msg.sender+": "+msg.text;
          document.getElementById("messages").appendChild(div);
        });
      }
    }
    window.joinRoom = joinRoom;

    // Chat
    document.getElementById("sendBtn").onclick = ()=>{
      const text = document.getElementById("msgInput").value;
      if(text && roomCode){
        db.ref("rooms/"+roomCode+"/chat").push({
          sender: playerId, text:text
        });
        document.getElementById("msgInput").value="";
      }
    };

    // Animate
    function animate(){
      requestAnimationFrame(animate);
      movePlayer();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
